<div class="position-relative w-100">
  <!-- Tag Input Container -->
  <div
    class="d-flex flex-wrap align-items-center p-2 border rounded bg-white"
    style="min-height: 40px"
  >
    <!-- Selected User Tags -->
    <div class="d-flex flex-wrap gap-1 me-2" *ngIf="hasSelectedUsers()">
      <div
        *ngFor="let user of selectedUsers(); trackBy: trackByUserId"
        class="d-inline-flex align-items-center gap-2 px-2 py-1 rounded-pill small border"
        [ngClass]="
          user.isInvalid
            ? 'bg-danger-subtle text-danger border-danger'
            : 'bg-primary-subtle text-primary border-primary'
        "
      >
        <!-- User Avatar -->
        <img
          [src]="user.avatar"
          [alt]="user.email"
          class="rounded-circle object-fit-cover"
          style="width: 20px; height: 20px"
          loading="lazy"
        />

        <!-- User Info (Show email instead of name) -->
        <span class="fw-medium">{{ user.email }}</span>

        <!-- Remove Button -->
        <button
          type="button"
          (click)="removeUser(user.id)"
          class="btn-close btn-close-sm ms-1"
          [ngClass]="user.isInvalid ? 'btn-close-danger' : 'btn-close-primary'"
          [attr.aria-label]="'Remove ' + user.email"
          style="font-size: 0.5rem; padding: 0; width: 0.5em; height: 0.5em"
        ></button>
      </div>
    </div>

    <!-- Input Field -->
    <div class="flex-grow-1" style="min-width: 128px">
      <input
        #inputRef
        type="text"
        [formControl]="searchControl"
        (keydown)="onInputKeydown($event)"
        (focus)="onInputFocus()"
        (blur)="onInputBlur()"
        placeholder="Type name or email..."
        class="form-control border-0 shadow-none bg-transparent small"
        autocomplete="off"
      />
    </div>

    <!-- Loading Indicator -->
    <div *ngIf="isLoading()" class="ms-2">
      <div
        class="spinner-border spinner-border-sm text-primary"
        role="status"
        style="width: 1rem; height: 1rem"
      >
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  </div>

  <!-- Suggestions Dropdown -->
  <div
    *ngIf="showSuggestions() && hasSuggestions()"
    class="position-absolute w-100 mt-1 bg-white border rounded shadow-lg overflow-auto"
    style="z-index: 1050; max-height: 15rem"
  >
    <div class="py-1">
      <!-- Existing Users -->
      <button
        *ngFor="let user of suggestions(); let i = index; trackBy: trackBySuggestionId"
        type="button"
        (click)="onSuggestionClick(user)"
        (mouseenter)="onSuggestionMouseEnter(i)"
        class="w-100 px-3 py-2 text-start border-0 bg-transparent"
        [ngClass]="activeSuggestionIndex() === i ? 'bg-light' : ''"
      >
        <div class="d-flex align-items-center gap-3">
          <!-- User Avatar -->
          <img
            [src]="user.avatar"
            [alt]="user.name"
            class="rounded-circle object-fit-cover flex-shrink-0"
            style="width: 32px; height: 32px"
            loading="lazy"
          />

          <!-- User Info -->
          <div class="flex-grow-1 overflow-hidden">
            <div class="fw-medium text-dark text-truncate">{{ user.name }}</div>
            <div class="small text-muted text-truncate">{{ user.email }}</div>
          </div>
        </div>
      </button>
    </div>
  </div>

  <!-- No Results Message -->
  <div
    *ngIf="showSuggestions() && !hasSuggestions() && !isLoading() && searchControl.value.trim()"
    class="position-absolute w-100 mt-1 bg-white border rounded shadow-lg"
    style="z-index: 1050"
  >
    <div class="px-3 py-4 text-center text-muted small">
      No users found. Press Enter to add "{{ searchControl.value.trim() }}"
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage()" class="mt-1 small text-danger">
    {{ errorMessage() }}
  </div>
</div>

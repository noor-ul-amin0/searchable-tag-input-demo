<div class="relative w-full">
  <!-- Tag Input Container -->
  <div
    class="flex flex-wrap items-center min-h-10 p-2 border border-gray-300 rounded-lg bg-white focus-within:border-blue-500 focus-within:ring-1 focus-within:ring-blue-500 transition-colors"
  >
    <!-- Selected User Tags -->
    <div class="flex flex-wrap gap-1 mr-2" *ngIf="hasSelectedUsers()">
      <div
        *ngFor="let user of selectedUsers(); trackBy: trackByUserId"
        class="inline-flex items-center gap-2 px-2 py-1 rounded-full text-sm border transition-colors"
        [class]="
          user.isInvalid
            ? 'bg-red-100 text-red-800 border-red-200'
            : 'bg-blue-100 text-blue-800 border-blue-200'
        "
      >
        <!-- User Avatar -->
        <img
          [src]="user.avatar"
          [alt]="user.email"
          class="w-5 h-5 rounded-full object-cover"
          loading="lazy"
        />

        <!-- User Info (Show email instead of name) -->
        <span class="font-medium">{{ user.email }}</span>

        <!-- Remove Button -->
        <button
          type="button"
          (click)="removeUser(user.id)"
          class="ml-1 hover:opacity-80 focus:outline-none focus:opacity-80 transition-opacity"
          [class]="user.isInvalid ? 'text-red-600' : 'text-blue-600'"
          [attr.aria-label]="'Remove ' + user.email"
        >
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
            <path
              fill-rule="evenodd"
              d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
              clip-rule="evenodd"
            ></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Input Field -->
    <div class="flex-1 min-w-32">
      <input
        #inputRef
        type="text"
        [formControl]="searchControl"
        (keydown)="onInputKeydown($event)"
        (focus)="onInputFocus()"
        (blur)="onInputBlur()"
        placeholder="Type name or email..."
        class="w-full border-none outline-none bg-transparent text-sm placeholder-gray-500"
        autocomplete="off"
      />
    </div>

    <!-- Loading Indicator -->
    <div *ngIf="isLoading()" class="ml-2">
      <div
        class="animate-spin h-4 w-4 border-2 border-blue-500 border-t-transparent rounded-full"
      ></div>
    </div>
  </div>

  <!-- Suggestions Dropdown -->
  <div
    *ngIf="showSuggestions() && hasSuggestions()"
    class="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"
  >
    <div class="py-1">
      <!-- Existing Users -->
      <button
        *ngFor="let user of suggestions(); let i = index; trackBy: trackBySuggestionId"
        type="button"
        (click)="onSuggestionClick(user)"
        (mouseenter)="onSuggestionMouseEnter(i)"
        class="w-full px-3 py-2 text-left hover:bg-gray-50 focus:bg-gray-50 focus:outline-none transition-colors"
        [class.bg-gray-50]="activeSuggestionIndex() === i"
      >
        <div class="flex items-center gap-3">
          <!-- User Avatar -->
          <img
            [src]="user.avatar"
            [alt]="user.name"
            class="w-8 h-8 rounded-full object-cover shrink-0"
            loading="lazy"
          />

          <!-- User Info -->
          <div class="flex-1 min-w-0">
            <div class="font-medium text-gray-900 truncate">{{ user.name }}</div>
            <div class="text-sm text-gray-500 truncate">{{ user.email }}</div>
          </div>
        </div>
      </button>
    </div>
  </div>

  <!-- No Results Message -->
  <div
    *ngIf="showSuggestions() && !hasSuggestions() && !isLoading() && searchControl.value.trim()"
    class="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg"
  >
    <div class="px-3 py-4 text-center text-gray-500 text-sm">
      No users found. Press Enter to add "{{ searchControl.value.trim() }}"
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage()" class="mt-1 text-sm text-red-600">
    {{ errorMessage() }}
  </div>
</div>
